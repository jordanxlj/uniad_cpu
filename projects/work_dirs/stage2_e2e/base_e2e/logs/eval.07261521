NOTE: Redirects are currently not supported in Windows or MacOs.
/opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/distributed/launch.py:163: DeprecationWarning: The 'warn' method is deprecated, use 'warning' instead
  logger.warn(
The module torch.distributed.launch is deprecated and going to be removed in future.Migrate to torch.distributed.run
WARNING:torch.distributed.run:--use_env is deprecated and will be removed in future releases.
 Please read local_rank from `os.environ('LOCAL_RANK')` instead.
INFO:torch.distributed.launcher.api:Starting elastic_operator with launch configs:
  entrypoint       : ./tools/test.py
  min_nodes        : 1
  max_nodes        : 1
  nproc_per_node   : 1
  run_id           : none
  rdzv_backend     : static
  rdzv_endpoint    : 127.0.0.1:28596
  rdzv_configs     : {'rank': 0, 'timeout': 900}
  max_restarts     : 3
  monitor_interval : 5
  log_dir          : None
  metrics_cfg      : {}

INFO:torch.distributed.elastic.agent.server.local_elastic_agent:log directory set to: /var/folders/bl/c09z1sm91mxfb8z7mn7v4rhh0000gq/T/torchelastic_7dnfiagn/none_oqk4fsxq
INFO:torch.distributed.elastic.agent.server.api:[default] starting workers for entrypoint: python
INFO:torch.distributed.elastic.agent.server.api:[default] Rendezvous'ing worker group
/opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/distributed/elastic/utils/store.py:52: FutureWarning: This is an experimental API and will be changed in future.
  warnings.warn(
INFO:torch.distributed.elastic.agent.server.api:[default] Rendezvous complete for workers. Result:
  restart_count=0
  master_addr=127.0.0.1
  master_port=28596
  group_rank=0
  group_world_size=1
  local_ranks=[0]
  role_ranks=[0]
  global_ranks=[0]
  role_world_sizes=[1]
  global_world_sizes=[1]

INFO:torch.distributed.elastic.agent.server.api:[default] Starting worker group
INFO:torch.distributed.elastic.multiprocessing:Setting worker0 reply file to: /var/folders/bl/c09z1sm91mxfb8z7mn7v4rhh0000gq/T/torchelastic_7dnfiagn/none_oqk4fsxq/attempt_0/0/error.json
projects.mmdet3d_plugin
======
Loading NuScenes tables for version v1.0-trainval...
23 category,
8 attribute,
4 visibility,
64386 instance,
12 sensor,
10200 calibrated_sensor,
2631083 ego_pose,
68 log,
850 scene,
34149 sample,
2631083 sample_data,
1166187 sample_annotation,
4 map,
Done loading in 22.457 seconds.
======
Reverse indexing ...
Done reverse indexing in 6.0 seconds.
======
load checkpoint from local path: ./ckpts/uniad_base_e2e.pth
2023-07-26 15:21:42,841 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.0.conv2 is upgraded to version 2.
2023-07-26 15:21:42,844 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.1.conv2 is upgraded to version 2.
2023-07-26 15:21:42,846 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.2.conv2 is upgraded to version 2.
2023-07-26 15:21:42,849 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.3.conv2 is upgraded to version 2.
2023-07-26 15:21:42,852 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.4.conv2 is upgraded to version 2.
2023-07-26 15:21:42,854 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.5.conv2 is upgraded to version 2.
2023-07-26 15:21:42,857 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.6.conv2 is upgraded to version 2.
2023-07-26 15:21:42,859 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.7.conv2 is upgraded to version 2.
2023-07-26 15:21:42,861 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.8.conv2 is upgraded to version 2.
2023-07-26 15:21:42,864 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.9.conv2 is upgraded to version 2.
2023-07-26 15:21:42,866 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.10.conv2 is upgraded to version 2.
2023-07-26 15:21:42,868 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.11.conv2 is upgraded to version 2.
2023-07-26 15:21:42,871 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.12.conv2 is upgraded to version 2.
2023-07-26 15:21:42,873 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.13.conv2 is upgraded to version 2.
2023-07-26 15:21:42,876 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.14.conv2 is upgraded to version 2.
2023-07-26 15:21:42,878 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.15.conv2 is upgraded to version 2.
2023-07-26 15:21:42,880 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.16.conv2 is upgraded to version 2.
2023-07-26 15:21:42,883 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.17.conv2 is upgraded to version 2.
2023-07-26 15:21:42,885 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.18.conv2 is upgraded to version 2.
2023-07-26 15:21:42,887 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.19.conv2 is upgraded to version 2.
2023-07-26 15:21:42,890 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.20.conv2 is upgraded to version 2.
2023-07-26 15:21:42,892 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.21.conv2 is upgraded to version 2.
2023-07-26 15:21:42,894 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.22.conv2 is upgraded to version 2.
2023-07-26 15:21:42,897 - root - INFO - ModulatedDeformConvPack img_backbone.layer4.0.conv2 is upgraded to version 2.
2023-07-26 15:21:42,901 - root - INFO - ModulatedDeformConvPack img_backbone.layer4.1.conv2 is upgraded to version 2.
2023-07-26 15:21:42,904 - root - INFO - ModulatedDeformConvPack img_backbone.layer4.2.conv2 is upgraded to version 2.
The model and loaded state dict do not match exactly

unexpected key in source state_dict: bbox_size_fc.weight, bbox_size_fc.bias, pts_bbox_head.query_embedding.weight, pts_bbox_head.transformer.reference_points.weight, pts_bbox_head.transformer.reference_points.bias

> /Users/liangming.xu/code/UniAD/tools/test.py(230)main()
-> result = model(return_loss=False, rescale=True, **data)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/detectors/uniad_track.py(723)simple_test_track()
-> bs = img.size(0)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/detectors/uniad_track.py(658)_forward_single_frame_inference()
-> bev_embed, bev_pos = self.get_bevs(img, img_metas, prev_bev=prev_bev)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(338)forward()
-> output = multi_scale_deformable_attn_pytorch(
(Pdb) 333  	            output = MultiScaleDeformableAttnFunction.apply(
334  	                value, spatial_shapes, level_start_index, sampling_locations,
335  	                attention_weights, self.im2col_step)
336  	        else:
337  	            import pdb; pdb.set_trace()
338  ->	            output = multi_scale_deformable_attn_pytorch(
339  	                value, spatial_shapes, sampling_locations, attention_weights)
340  	
341  	        output = self.output_proj(output)
342  	
343  	        if not self.batch_first:
(Pdb) torch.Size([1, 40000, 8, 32])
(Pdb) tensor([[200, 200]])
(Pdb) torch.Size([1])
(Pdb) torch.Size([1, 901, 8, 1, 4, 2])
(Pdb) torch.Size([1, 901, 8, 1, 4])
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(339)forward()
-> value, spatial_shapes, sampling_locations, attention_weights)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(338)forward()
-> output = multi_scale_deformable_attn_pytorch(
(Pdb) --Call--
> /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(94)multi_scale_deformable_attn_pytorch()
-> def multi_scale_deformable_attn_pytorch(value, value_spatial_shapes,
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(116)multi_scale_deformable_attn_pytorch()
-> bs, _, num_heads, embed_dims = value.shape
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(118)multi_scale_deformable_attn_pytorch()
-> sampling_locations.shape
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(117)multi_scale_deformable_attn_pytorch()
-> _, num_queries, num_heads, num_levels, num_points, _ =\
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(119)multi_scale_deformable_attn_pytorch()
-> value_list = value.split([H_ * W_ for H_, W_ in value_spatial_shapes],
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(120)multi_scale_deformable_attn_pytorch()
-> dim=1)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(119)multi_scale_deformable_attn_pytorch()
-> value_list = value.split([H_ * W_ for H_, W_ in value_spatial_shapes],
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(121)multi_scale_deformable_attn_pytorch()
-> sampling_grids = 2 * sampling_locations - 1
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(122)multi_scale_deformable_attn_pytorch()
-> sampling_value_list = []
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(123)multi_scale_deformable_attn_pytorch()
-> for level, (H_, W_) in enumerate(value_spatial_shapes):
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(128)multi_scale_deformable_attn_pytorch()
-> value_l_ = value_list[level].flatten(2).transpose(1, 2).reshape(
(Pdb) *** AttributeError: 'tuple' object has no attribute 'shape'
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(129)multi_scale_deformable_attn_pytorch()
-> bs * num_heads, embed_dims, H_, W_)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(128)multi_scale_deformable_attn_pytorch()
-> value_l_ = value_list[level].flatten(2).transpose(1, 2).reshape(
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(133)multi_scale_deformable_attn_pytorch()
-> sampling_grid_l_ = sampling_grids[:, :, :,
(Pdb) torch.Size([8, 32, 200, 200])
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(134)multi_scale_deformable_attn_pytorch()
-> level].transpose(1, 2).flatten(0, 1)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(133)multi_scale_deformable_attn_pytorch()
-> sampling_grid_l_ = sampling_grids[:, :, :,
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(134)multi_scale_deformable_attn_pytorch()
-> level].transpose(1, 2).flatten(0, 1)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(133)multi_scale_deformable_attn_pytorch()
-> sampling_grid_l_ = sampling_grids[:, :, :,
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(134)multi_scale_deformable_attn_pytorch()
-> level].transpose(1, 2).flatten(0, 1)
(Pdb) *** NameError: name 'sampling_grid_l_' is not defined
(Pdb) (Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(133)multi_scale_deformable_attn_pytorch()
-> sampling_grid_l_ = sampling_grids[:, :, :,
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(136)multi_scale_deformable_attn_pytorch()
-> sampling_value_l_ = F.grid_sample(
(Pdb) torch.Size([8, 901, 4, 2])
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(137)multi_scale_deformable_attn_pytorch()
-> value_l_,
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(138)multi_scale_deformable_attn_pytorch()
-> sampling_grid_l_,
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(139)multi_scale_deformable_attn_pytorch()
-> mode='bilinear',
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(140)multi_scale_deformable_attn_pytorch()
-> padding_mode='zeros',
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(141)multi_scale_deformable_attn_pytorch()
-> align_corners=False)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(136)multi_scale_deformable_attn_pytorch()
-> sampling_value_l_ = F.grid_sample(
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(142)multi_scale_deformable_attn_pytorch()
-> sampling_value_list.append(sampling_value_l_)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(123)multi_scale_deformable_attn_pytorch()
-> for level, (H_, W_) in enumerate(value_spatial_shapes):
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(146)multi_scale_deformable_attn_pytorch()
-> attention_weights = attention_weights.transpose(1, 2).reshape(
(Pdb) torch.Size([1, 901, 8, 1, 4])
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(338)forward()
-> output = multi_scale_deformable_attn_pytorch(
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/utils/misc.py(340)new_func()
-> output = old_func(*args, **kwargs)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/nn/modules/module.py(1051)_call_impl()
-> return forward_call(*input, **kwargs)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/cnn/bricks/transformer.py(492)forward()
-> query = self.attentions[attn_index](
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/nn/modules/module.py(1051)_call_impl()
-> return forward_call(*input, **kwargs)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(98)forward()
-> output = layer(
(Pdb)  93  	        intermediate_reference_points = []
 94  	        for lid, layer in enumerate(self.layers):
 95  	
 96  	            reference_points_input = reference_points[..., :2].unsqueeze(
 97  	                2)  # BS NUM_QUERY NUM_LEVEL 2
 98  ->	            output = layer(
 99  	                output,
100  	                *args,
101  	                reference_points=reference_points_input,
102  	                key_padding_mask=key_padding_mask,
103  	                **kwargs)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/nn/modules/module.py(1051)_call_impl()
-> return forward_call(*input, **kwargs)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/cnn/bricks/transformer.py(492)forward()
-> query = self.attentions[attn_index](
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/nn/modules/module.py(1051)_call_impl()
-> return forward_call(*input, **kwargs)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/utils/misc.py(340)new_func()
-> output = old_func(*args, **kwargs)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(338)forward()
-> output = multi_scale_deformable_attn_pytorch(
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(146)multi_scale_deformable_attn_pytorch()
-> attention_weights = attention_weights.transpose(1, 2).reshape(
(Pdb) torch.Size([1, 901, 8, 1, 4])
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(147)multi_scale_deformable_attn_pytorch()
-> bs * num_heads, 1, num_queries, num_levels * num_points)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(146)multi_scale_deformable_attn_pytorch()
-> attention_weights = attention_weights.transpose(1, 2).reshape(
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(149)multi_scale_deformable_attn_pytorch()
-> output = (torch.stack(sampling_value_list, dim=-2).flatten(-2) *
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(150)multi_scale_deformable_attn_pytorch()
-> attention_weights).sum(-1).view(bs, num_heads * embed_dims,
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(149)multi_scale_deformable_attn_pytorch()
-> output = (torch.stack(sampling_value_list, dim=-2).flatten(-2) *
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(150)multi_scale_deformable_attn_pytorch()
-> attention_weights).sum(-1).view(bs, num_heads * embed_dims,
(Pdb) tensor([[[[-9.4112e-01, -9.8433e-01, -9.3053e-01, -9.7435e-01],
          [-9.9300e-01, -1.0711e+00, -1.1828e+00, -1.0972e+00],
          [-1.3069e+00, -1.9083e+00, -1.3985e+00, -1.2379e+00],
          ...,
          [-7.8032e-01, -1.2403e+00, -8.7789e-01, -1.1431e+00],
          [-1.8935e+00, -1.8556e+00, -1.8830e+00, -1.6762e+00],
          [-1.0739e+00, -9.0308e-01, -9.8464e-01, -1.1409e+00]],

         [[-4.9575e-01, -2.0002e-01, -3.0696e-01, -1.1090e-01],
          [ 3.4063e-01, -3.8216e-01,  3.4290e-02, -5.1187e-02],
          [ 4.4233e-01,  7.0815e-01,  5.7907e-01,  5.2399e-01],
          ...,
          [-5.2914e-01, -5.2665e-01, -5.5862e-01, -5.7435e-01],
          [ 6.8189e-01,  7.3185e-01,  6.7547e-01,  9.9517e-01],
          [-3.2128e-01, -1.6479e-01,  1.2007e-01, -9.7740e-02]],

         [[ 1.0247e+00,  1.0791e+00,  1.0392e+00,  1.0745e+00],
          [-7.4972e-01, -8.6380e-01, -7.2515e-01, -5.0394e-01],
          [-3.7470e-01, -1.5416e-01, -2.7841e-01,  2.9238e-02],
          ...,
          [-2.3822e-03,  2.0866e-01, -3.0017e-02,  3.4442e-01],
          [-8.8672e-01, -8.2872e-01, -8.1237e-01, -6.0697e-01],
          [ 6.6984e-01,  4.6163e-01,  5.4332e-01,  6.6925e-01]],

         ...,

         [[-3.5065e-01, -2.7660e-01, -2.8762e-01, -3.2535e-01],
          [-9.8845e-01, -9.7877e-01, -1.1335e+00, -1.0990e+00],
          [-9.7154e-01, -1.1902e+00, -9.6142e-01, -8.4078e-01],
          ...,
          [ 1.2204e+00,  3.2779e-01,  1.0994e+00,  1.2252e-01],
          [-3.1914e-01, -2.1181e-01, -2.1341e-01, -1.7354e-01],
          [-1.3480e+00, -1.0637e+00, -9.5554e-01, -5.5930e-01]],

         [[-1.5898e+00, -1.5258e+00, -1.5406e+00, -1.3347e+00],
          [-1.7197e+00, -1.5284e+00, -1.8226e+00, -1.8055e+00],
          [-1.8720e+00, -1.8326e+00, -1.8186e+00, -1.7883e+00],
          ...,
          [-2.4717e+00, -2.0105e+00, -2.4804e+00, -1.7601e+00],
          [-1.9481e+00, -1.9475e+00, -1.9677e+00, -2.0151e+00],
          [-1.2223e+00, -1.2533e+00, -1.1329e+00, -1.4853e+00]],

         [[ 9.4681e-01,  1.1510e+00,  1.0390e+00,  9.0043e-01],
          [-4.5202e-01, -9.9430e-01, -4.7525e-01, -4.7157e-01],
          [-7.9040e-01, -5.3256e-01, -8.2446e-01, -8.6879e-01],
          ...,
          [ 2.3271e-02,  7.2817e-01,  1.7651e-01,  8.2350e-01],
          [-6.8407e-02, -6.2079e-03, -2.6819e-02, -3.3624e-02],
          [ 8.3188e-01,  6.9159e-01,  6.7875e-01,  9.9138e-01]]],


        [[[ 5.5444e-01,  1.3176e+00,  1.5344e+00,  2.1301e+00],
          [ 1.1896e+00,  1.8319e+00,  1.4742e+00,  1.4456e+00],
          [ 1.3064e+00,  9.6665e-01,  1.0494e+00,  5.5083e-01],
          ...,
          [ 6.2008e-01,  1.3006e+00,  2.1345e+00,  2.2735e+00],
          [ 8.7577e-01,  1.3510e+00,  7.5040e-01,  0.0000e+00],
          [-3.0123e-01, -4.5491e-01,  2.2617e-02, -9.8734e-01]],

         [[-1.2383e-01, -4.5264e-01,  1.2264e-01, -4.8730e-01],
          [-5.4617e-03, -6.0009e-01, -6.7558e-01, -1.3464e+00],
          [-3.3515e-01, -1.5660e-01, -7.2868e-01, -6.0491e-01],
          ...,
          [-1.1500e+00, -1.4214e+00, -4.8665e-01, -1.4468e+00],
          [-1.3324e+00, -1.1706e+00, -1.3274e+00,  0.0000e+00],
          [ 6.5513e-01, -4.3052e-02,  6.4668e-01,  3.5409e-01]],

         [[ 6.9623e-01,  3.4352e-01,  8.6316e-01,  4.7673e-01],
          [-7.5520e-01, -4.5370e-01,  7.7508e-02, -1.9071e-01],
          [-5.1123e-01, -3.9564e-01, -3.4617e-01, -4.9666e-01],
          ...,
          [-5.4928e-02, -1.8679e-01,  3.1424e-01,  1.2211e-01],
          [-3.8021e-01,  1.3530e-01, -5.1239e-01,  0.0000e+00],
          [ 1.9727e+00,  1.9428e+00,  2.0537e+00,  1.7612e+00]],

         ...,

         [[-6.7016e-02, -3.4628e-01, -6.4842e-01, -9.3833e-01],
          [-1.6562e+00, -2.9645e+00, -1.4146e+00, -2.8472e+00],
          [-2.2868e+00, -2.4810e+00, -2.8085e+00, -2.7086e+00],
          ...,
          [-2.4827e-01, -7.4486e-01, -9.2429e-01, -1.2738e+00],
          [-3.7604e+00, -3.3252e+00, -3.5808e+00,  0.0000e+00],
          [-1.9890e-01,  2.5836e-01,  1.0642e-02,  2.0484e-01]],

         [[-1.2766e+00, -7.5690e-01, -3.0498e-01, -2.1410e-02],
          [ 8.0273e-01,  1.2976e+00,  5.5020e-01,  1.1721e+00],
          [ 1.7933e+00,  1.5842e+00,  1.8258e+00,  1.6631e+00],
          ...,
          [ 3.4914e-02,  2.9519e-01,  2.4978e-01,  1.0057e+00],
          [ 2.2223e+00,  1.9737e+00,  2.2055e+00,  0.0000e+00],
          [-3.2313e-01, -2.0063e-01, -4.1456e-01, -2.0922e-01]],

         [[ 1.5653e+00,  1.2880e+00,  1.3057e+00,  9.6798e-01],
          [ 1.6439e-01, -5.9466e-01, -1.6610e-01, -6.6100e-01],
          [-6.5815e-01, -6.2601e-01, -1.1691e+00, -9.0100e-01],
          ...,
          [ 5.1203e-01,  4.0385e-01,  7.5856e-01,  1.4664e-01],
          [-1.5680e+00, -1.2820e+00, -1.6653e+00,  0.0000e+00],
          [ 5.1274e-01,  3.9683e-01,  5.8502e-01,  3.1174e-01]]],


        [[[ 8.2164e-01,  7.0613e-01,  4.9035e-01,  7.1359e-01],
          [-1.7646e-02,  7.9154e-02,  1.1404e-01, -1.0112e-02],
          [ 4.3497e-01,  2.6515e-01, -7.8293e-02,  1.9602e-01],
          ...,
          [-2.7651e-01, -1.7167e-01, -1.8313e-01, -1.6914e-01],
          [-3.0009e-01, -6.8123e-02, -3.0908e-03,  2.2850e-02],
          [ 3.0698e-01, -6.3464e-02,  1.2393e-01,  1.6819e-01]],

         [[-1.3931e+00, -1.2051e+00, -9.2758e-01, -1.5013e+00],
          [-8.7712e-01, -8.9813e-01, -3.1763e-01, -3.0033e-01],
          [-1.6992e+00, -1.8508e+00, -1.8579e+00, -1.8769e+00],
          ...,
          [-6.5529e-01, -7.3924e-01, -8.4430e-01, -1.0918e+00],
          [-1.4314e+00, -1.4388e+00, -1.3838e+00, -1.4362e+00],
          [-1.6096e+00, -1.3743e+00, -1.3495e+00, -1.2792e+00]],

         [[-7.7289e-01, -7.8940e-01, -7.2845e-01, -9.5276e-01],
          [-4.4034e-01, -3.7062e-01, -6.1972e-01, -7.2735e-01],
          [-4.4801e-01, -4.5483e-01, -2.7108e-01, -3.8137e-01],
          ...,
          [-3.6209e-01, -6.5473e-01, -2.1469e-01, -3.1257e-01],
          [ 5.7610e-01,  3.2862e-01, -6.1758e-02,  2.5003e-01],
          [-1.2934e+00, -9.4411e-01, -1.4444e+00, -1.4081e+00]],

         ...,

         [[ 8.9020e-01,  8.8642e-01,  8.3115e-01,  9.0848e-01],
          [-9.5183e-01, -8.8809e-01, -9.4036e-01, -8.8856e-01],
          [ 8.5363e-01,  8.4951e-01,  3.1479e-01,  6.2471e-01],
          ...,
          [ 5.1831e-01,  7.5741e-01,  6.0130e-01,  2.3850e-01],
          [-6.1518e-01, -4.7659e-01, -4.3863e-01, -4.8984e-01],
          [ 1.0060e+00,  6.8412e-01,  8.7527e-01,  1.1762e+00]],

         [[ 1.5970e-03,  1.3296e-01,  4.5983e-01,  2.6503e-01],
          [-1.0614e+00, -1.1716e+00, -4.5128e-01, -3.0045e-01],
          [-6.0161e-01, -6.9572e-01, -8.8418e-01, -7.5601e-01],
          ...,
          [ 8.5926e-01,  1.0119e+00,  7.2822e-01,  6.9070e-01],
          [-9.0362e-01, -1.0099e+00, -1.1043e+00, -1.0629e+00],
          [-2.3941e-01,  4.5004e-01,  3.8892e-01,  3.8035e-01]],

         [[ 1.0319e+00,  1.0434e+00,  8.6951e-01,  9.8799e-01],
          [-4.9755e-01, -5.9779e-01, -6.8977e-01, -5.2269e-01],
          [-1.3027e+00, -9.7949e-01, -5.5150e-01, -9.2049e-01],
          ...,
          [ 4.2308e-01,  6.5067e-01,  1.8320e-01,  2.4354e-01],
          [-1.0145e+00, -9.1273e-01, -8.1094e-01, -8.9337e-01],
          [ 7.4094e-01,  1.3761e+00,  1.0260e+00,  7.1410e-01]]],


        ...,


        [[[-7.2532e-01, -2.7428e-01,  5.1832e-01, -2.3142e-01],
          [ 4.4956e-01, -9.3691e-02,  3.9062e-01,  6.8132e-01],
          [ 4.9015e-01,  1.6333e-01,  5.5510e-01, -5.4416e-01],
          ...,
          [ 6.3782e-01, -3.1883e-01,  7.9272e-01,  4.9502e-01],
          [ 1.3018e+00,  1.3110e+00,  1.4700e+00,  1.5110e+00],
          [ 5.2686e-01,  3.4046e-01,  5.4644e-01,  4.0433e-01]],

         [[ 3.9415e-01,  1.5730e+00,  7.0831e-01,  1.2432e+00],
          [ 4.3737e-01, -3.1812e-01, -3.1342e-01, -1.9926e-01],
          [ 1.5100e-01,  3.0878e-01, -4.7902e-01,  7.3719e-01],
          ...,
          [-5.4397e-02,  9.2689e-01, -1.2222e-01,  3.9962e-01],
          [-1.6946e+00, -1.3106e+00, -1.4534e+00, -1.3985e+00],
          [ 6.6456e-01,  1.8945e-01,  9.1856e-01,  8.3689e-01]],

         [[ 1.3042e+00,  1.1787e+00,  1.0627e+00,  6.3660e-01],
          [-3.9920e-03, -2.0124e-01, -5.6068e-01, -5.9322e-01],
          [-8.5658e-01, -1.6238e+00, -4.2255e-01, -6.6939e-01],
          ...,
          [ 1.4059e+00,  1.0031e+00,  1.9154e+00,  5.7893e-01],
          [-3.4616e-01, -1.1585e+00, -1.1945e-01,  4.2115e-01],
          [ 9.9614e-01,  1.2634e+00,  1.2882e+00,  1.0335e+00]],

         ...,

         [[-7.6183e-01,  6.9916e-01,  3.7720e-02,  4.5674e-01],
          [ 7.9843e-01,  2.4337e+00,  2.0445e+00,  2.2960e+00],
          [ 3.8987e-01, -6.9415e-02,  4.8759e-01, -6.7060e-01],
          ...,
          [ 4.1905e-02,  5.0252e-01,  6.2424e-01,  1.5794e-01],
          [ 2.2207e+00,  1.3184e+00,  2.1399e+00,  2.1146e+00],
          [-4.7532e-02,  4.2925e-01,  5.0254e-01,  1.7918e-02]],

         [[ 1.2970e-01, -7.3228e-01, -4.8589e-01, -7.5559e-01],
          [ 8.9869e-01, -1.1291e-01,  2.6549e-01,  9.0890e-02],
          [-4.7467e-01, -4.9241e-01,  2.7153e-01, -2.3443e-01],
          ...,
          [ 6.8470e-02, -4.4382e-01, -1.3719e+00,  1.1109e+00],
          [-8.3825e-01, -3.2961e-01, -7.1799e-01, -1.2937e-01],
          [-4.4656e-01, -4.8392e-01, -7.5236e-01, -4.8100e-01]],

         [[-1.8008e+00, -3.1927e+00, -1.9102e+00, -1.4898e+00],
          [-7.5943e-01, -1.7511e+00, -1.1734e+00, -1.4205e+00],
          [-5.9721e-01, -5.5930e-01, -1.7760e-01, -8.7156e-01],
          ...,
          [-8.8600e-01, -2.6742e+00, -1.3131e+00, -9.9820e-01],
          [-1.2914e+00, -1.1809e+00, -1.4714e+00, -5.2970e-01],
          [-1.7419e+00, -9.8906e-01, -1.8869e+00, -1.6786e+00]]],


        [[[-1.0619e+00, -9.9856e-01, -1.0484e+00, -9.8558e-01],
          [-7.4692e-01, -8.8926e-01, -7.0494e-01, -1.1625e+00],
          [-1.2555e+00, -1.2205e+00, -1.3077e+00, -1.0661e+00],
          ...,
          [-4.4692e-01, -4.8725e-01, -2.1648e-01, -2.4723e-01],
          [-5.9187e-01, -7.1402e-01, -6.1373e-01, -7.4194e-01],
          [ 2.0398e-01, -5.7037e-01,  3.0479e-01, -1.0416e-01]],

         [[ 1.3635e+00,  1.4787e+00,  1.2345e+00,  1.5070e+00],
          [ 2.0746e-01,  3.4263e-01,  3.1794e-01,  4.1731e-01],
          [ 2.7801e-01,  3.6946e-01,  5.1496e-01,  2.0941e-01],
          ...,
          [ 1.4095e+00,  1.4618e+00,  1.5604e+00,  1.4456e+00],
          [-2.3099e-01, -7.8790e-02, -2.0264e-01, -2.6558e-01],
          [ 1.3878e+00,  1.2501e+00,  1.3485e+00,  1.4573e+00]],

         [[ 2.0263e+00,  1.8340e+00,  2.2539e+00,  1.7407e+00],
          [ 1.5692e-01,  1.9617e-01, -2.0612e-02,  2.4012e-01],
          [ 1.4469e+00,  1.3263e+00,  1.3884e+00,  1.5289e+00],
          ...,
          [ 2.9478e+00,  2.7830e+00,  2.7415e+00,  2.6783e+00],
          [ 4.3044e-01,  4.7235e-01,  4.5869e-01,  9.2007e-01],
          [ 1.0256e+00,  1.0381e+00,  8.8179e-01,  7.8681e-01]],

         ...,

         [[-1.4034e+00, -1.3053e+00, -1.6893e+00, -1.3792e+00],
          [-2.9053e-01, -4.0513e-01, -1.3470e-01, -2.7127e-01],
          [-1.5461e+00, -1.5925e+00, -1.6471e+00, -1.6572e+00],
          ...,
          [-1.5838e+00, -1.6709e+00, -1.6534e+00, -1.5963e+00],
          [-2.0660e+00, -2.0722e+00, -2.0653e+00, -2.0180e+00],
          [-1.0421e+00, -1.6546e+00, -9.9062e-01, -1.2492e+00]],

         [[ 9.5193e-01,  9.2009e-01,  8.8005e-01,  1.0332e+00],
          [ 7.5428e-01,  7.5411e-01,  4.8238e-01,  4.9204e-02],
          [ 2.2013e-01,  2.9216e-01,  1.2582e-01,  2.2344e-01],
          ...,
          [ 5.7208e-01,  3.1205e-01,  5.5414e-01,  4.0642e-01],
          [ 7.5951e-01,  6.6160e-01,  7.8604e-01,  3.4165e-01],
          [ 6.6874e-01,  5.1392e-01,  6.9603e-01,  5.1221e-01]],

         [[-2.5189e-02, -8.5946e-02,  2.8895e-01,  2.7488e-01],
          [-5.7941e-01, -5.5834e-01, -5.4611e-01, -3.8144e-01],
          [-8.7049e-01, -9.7602e-01, -9.1724e-01, -8.6046e-01],
          ...,
          [-5.1961e-01, -2.2068e-01, -8.8931e-01, -5.1944e-01],
          [-9.3057e-01, -9.4372e-01, -9.2750e-01, -7.9388e-01],
          [ 6.2513e-01,  6.3813e-01,  6.9399e-01,  6.1577e-01]]],


        [[[-8.3499e-01, -3.4211e-01, -1.4185e-01, -3.4956e-01],
          [-1.3821e+00, -7.0268e-01, -8.6460e-01, -1.1330e+00],
          [-6.7089e-01,  4.9020e-01,  2.7552e-01, -4.7039e-01],
          ...,
          [-2.6220e-01,  4.1104e-01,  4.3228e-01, -1.6440e-01],
          [ 8.6468e-01,  6.2637e-01,  9.2421e-01,  1.1305e+00],
          [-3.1783e-01, -5.5057e-01, -5.2837e-01, -1.0517e+00]],

         [[-6.9154e-01, -9.0023e-01, -7.0836e-01, -6.5728e-01],
          [ 6.8744e-01,  6.6265e-01,  2.2535e+00,  1.2986e+00],
          [ 1.2632e+00,  1.6323e+00,  1.5939e+00,  2.0335e+00],
          ...,
          [-1.3553e+00,  4.5408e-01,  6.9901e-02, -6.9384e-01],
          [ 7.8816e-01,  1.3153e+00,  1.1398e+00,  1.0623e+00],
          [ 3.6486e-01,  2.8278e-01, -4.3358e-01,  3.2687e-01]],

         [[-5.7169e-01, -1.3768e+00, -1.5927e+00, -1.7856e+00],
          [ 1.5021e-01, -1.1834e+00, -1.5685e+00, -1.2708e+00],
          [ 7.0590e-01, -3.2002e-01, -4.8102e-01,  5.7961e-01],
          ...,
          [-1.3979e+00, -2.4887e+00, -1.7235e+00, -1.6402e+00],
          [ 3.2052e-02,  9.8541e-01,  6.8162e-01,  7.5807e-01],
          [-1.1383e+00, -1.3279e+00, -4.8333e-01, -9.6060e-01]],

         ...,

         [[-1.4917e-02, -1.0841e+00, -1.0996e+00, -1.4568e+00],
          [-1.0398e+00, -3.2333e-02, -7.7415e-01, -9.8742e-01],
          [-1.0036e+00, -6.1662e-01, -7.3198e-01, -9.8167e-01],
          ...,
          [-2.3890e-01, -1.4630e+00, -6.7738e-01, -1.1877e+00],
          [-1.2393e-01,  4.6429e-01,  2.4337e-01,  7.7766e-01],
          [-1.0957e+00, -1.2664e+00, -9.9001e-01, -2.1536e-01]],

         [[-2.7603e-02,  1.4630e-01,  1.7916e-01,  6.5869e-01],
          [-4.3539e-01, -5.0451e-01, -9.0108e-01, -8.5527e-01],
          [-9.5116e-01, -2.2911e-01, -4.2346e-01, -5.8768e-01],
          ...,
          [-3.3063e-01,  6.3726e-01,  2.1968e-01,  1.7324e-01],
          [-3.8695e-01, -3.6845e-01, -2.5619e-01, -1.2104e-02],
          [-6.8717e-01, -2.6639e-01, -3.0425e-01, -6.1048e-01]],

         [[-1.4605e+00, -9.6614e-01, -6.8151e-01, -8.3991e-01],
          [-1.2794e-01, -7.0787e-01, -2.0285e-01, -5.0673e-01],
          [ 1.0928e-01,  3.5650e-02, -2.9687e-01,  5.9200e-01],
          ...,
          [-1.0548e+00, -3.7821e-02, -3.4013e-01, -8.3233e-01],
          [-9.3933e-01, -8.3555e-01, -7.5051e-01, -9.7009e-01],
          [-1.2206e+00, -6.8470e-01, -1.7840e+00, -9.4675e-01]]]])
(Pdb) torch.Size([8, 32, 901, 4])
(Pdb) torch.Size([8, 1, 901, 4])
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(338)forward()
-> output = multi_scale_deformable_attn_pytorch(
(Pdb) 333  	            output = MultiScaleDeformableAttnFunction.apply(
334  	                value, spatial_shapes, level_start_index, sampling_locations,
335  	                attention_weights, self.im2col_step)
336  	        else:
337  	            import pdb; pdb.set_trace()
338  ->	            output = multi_scale_deformable_attn_pytorch(
339  	                value, spatial_shapes, sampling_locations, attention_weights)
340  	
341  	        output = self.output_proj(output)
342  	
343  	        if not self.batch_first:
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/mmcv/ops/multi_scale_deform_attn.py(150)multi_scale_deformable_attn_pytorch()
-> attention_weights).sum(-1).view(bs, num_heads * embed_dims,
(Pdb) 145  	    # (bs, num_heads, 1, num_queries, num_levels*num_points)
146  	    attention_weights = attention_weights.transpose(1, 2).reshape(
147  	        bs * num_heads, 1, num_queries, num_levels * num_points)
148  	    #import pdb; pdb.set_trace()
149  	    output = (torch.stack(sampling_value_list, dim=-2).flatten(-2) *
150  ->	              attention_weights).sum(-1).view(bs, num_heads * embed_dims,
151  	                                              num_queries)
152  	    return output.transpose(1, 2).contiguous()
153  	
154  	
155  	@ATTENTION.register_module()
(Pdb) torch.Size([8, 32, 901, 4])
(Pdb) 