NOTE: Redirects are currently not supported in Windows or MacOs.
/opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/distributed/launch.py:163: DeprecationWarning: The 'warn' method is deprecated, use 'warning' instead
  logger.warn(
The module torch.distributed.launch is deprecated and going to be removed in future.Migrate to torch.distributed.run
WARNING:torch.distributed.run:--use_env is deprecated and will be removed in future releases.
 Please read local_rank from `os.environ('LOCAL_RANK')` instead.
INFO:torch.distributed.launcher.api:Starting elastic_operator with launch configs:
  entrypoint       : ./tools/test.py
  min_nodes        : 1
  max_nodes        : 1
  nproc_per_node   : 1
  run_id           : none
  rdzv_backend     : static
  rdzv_endpoint    : 127.0.0.1:28596
  rdzv_configs     : {'rank': 0, 'timeout': 900}
  max_restarts     : 3
  monitor_interval : 5
  log_dir          : None
  metrics_cfg      : {}

INFO:torch.distributed.elastic.agent.server.local_elastic_agent:log directory set to: /var/folders/bl/c09z1sm91mxfb8z7mn7v4rhh0000gq/T/torchelastic_jfj3wmhg/none_nj7oli7t
INFO:torch.distributed.elastic.agent.server.api:[default] starting workers for entrypoint: python
INFO:torch.distributed.elastic.agent.server.api:[default] Rendezvous'ing worker group
/opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/distributed/elastic/utils/store.py:52: FutureWarning: This is an experimental API and will be changed in future.
  warnings.warn(
INFO:torch.distributed.elastic.agent.server.api:[default] Rendezvous complete for workers. Result:
  restart_count=0
  master_addr=127.0.0.1
  master_port=28596
  group_rank=0
  group_world_size=1
  local_ranks=[0]
  role_ranks=[0]
  global_ranks=[0]
  role_world_sizes=[1]
  global_world_sizes=[1]

INFO:torch.distributed.elastic.agent.server.api:[default] Starting worker group
INFO:torch.distributed.elastic.multiprocessing:Setting worker0 reply file to: /var/folders/bl/c09z1sm91mxfb8z7mn7v4rhh0000gq/T/torchelastic_jfj3wmhg/none_nj7oli7t/attempt_0/0/error.json
projects.mmdet3d_plugin
======
Loading NuScenes tables for version v1.0-trainval...
23 category,
8 attribute,
4 visibility,
64386 instance,
12 sensor,
10200 calibrated_sensor,
2631083 ego_pose,
68 log,
850 scene,
34149 sample,
2631083 sample_data,
1166187 sample_annotation,
4 map,
Done loading in 23.174 seconds.
======
Reverse indexing ...
Done reverse indexing in 6.1 seconds.
======
load checkpoint from local path: ./ckpts/uniad_base_e2e.pth
2023-07-25 23:08:37,046 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.0.conv2 is upgraded to version 2.
2023-07-25 23:08:37,049 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.1.conv2 is upgraded to version 2.
2023-07-25 23:08:37,052 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.2.conv2 is upgraded to version 2.
2023-07-25 23:08:37,054 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.3.conv2 is upgraded to version 2.
2023-07-25 23:08:37,057 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.4.conv2 is upgraded to version 2.
2023-07-25 23:08:37,059 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.5.conv2 is upgraded to version 2.
2023-07-25 23:08:37,062 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.6.conv2 is upgraded to version 2.
2023-07-25 23:08:37,064 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.7.conv2 is upgraded to version 2.
2023-07-25 23:08:37,066 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.8.conv2 is upgraded to version 2.
2023-07-25 23:08:37,069 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.9.conv2 is upgraded to version 2.
2023-07-25 23:08:37,072 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.10.conv2 is upgraded to version 2.
2023-07-25 23:08:37,074 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.11.conv2 is upgraded to version 2.
2023-07-25 23:08:37,076 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.12.conv2 is upgraded to version 2.
2023-07-25 23:08:37,079 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.13.conv2 is upgraded to version 2.
2023-07-25 23:08:37,081 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.14.conv2 is upgraded to version 2.
2023-07-25 23:08:37,084 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.15.conv2 is upgraded to version 2.
2023-07-25 23:08:37,086 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.16.conv2 is upgraded to version 2.
2023-07-25 23:08:37,088 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.17.conv2 is upgraded to version 2.
2023-07-25 23:08:37,091 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.18.conv2 is upgraded to version 2.
2023-07-25 23:08:37,093 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.19.conv2 is upgraded to version 2.
2023-07-25 23:08:37,096 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.20.conv2 is upgraded to version 2.
2023-07-25 23:08:37,098 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.21.conv2 is upgraded to version 2.
2023-07-25 23:08:37,101 - root - INFO - ModulatedDeformConvPack img_backbone.layer3.22.conv2 is upgraded to version 2.
2023-07-25 23:08:37,103 - root - INFO - ModulatedDeformConvPack img_backbone.layer4.0.conv2 is upgraded to version 2.
2023-07-25 23:08:37,107 - root - INFO - ModulatedDeformConvPack img_backbone.layer4.1.conv2 is upgraded to version 2.
2023-07-25 23:08:37,110 - root - INFO - ModulatedDeformConvPack img_backbone.layer4.2.conv2 is upgraded to version 2.
The model and loaded state dict do not match exactly

unexpected key in source state_dict: bbox_size_fc.weight, bbox_size_fc.bias, pts_bbox_head.query_embedding.weight, pts_bbox_head.transformer.reference_points.weight, pts_bbox_head.transformer.reference_points.bias

> /Users/liangming.xu/code/UniAD/tools/test.py(229)main()
-> result = model(return_loss=False, rescale=True, **data)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/detectors/uniad_track.py(723)simple_test_track()
-> bs = img.size(0)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/detectors/uniad_track.py(641)_forward_single_frame_inference()
-> active_inst = track_instances[track_instances.obj_idxes >= 0]
(Pdb) 636  	        img: B, num_cam, C, H, W = img.shape
637  	        """
638  	
639  	        """ velo update """
640  	        import pdb; pdb.set_trace()
641  ->	        active_inst = track_instances[track_instances.obj_idxes >= 0]
642  	        other_inst = track_instances[track_instances.obj_idxes < 0]
643  	
644  	        if l2g_r2 is not None and len(active_inst) > 0 and l2g_r1 is not None:
645  	            ref_pts = active_inst.ref_pts
646  	            velo = active_inst.pred_boxes[:, -2:]
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(280)forward()
-> if value is None:
(Pdb) 275  	
276  	        Returns:
277  	             Tensor: forwarded results with shape [num_query, bs, embed_dims].
278  	        """
279  	        import pdb; pdb.set_trace()
280  ->	        if value is None:
281  	            value = query
282  	
283  	        if identity is None:
284  	            identity = query
285  	        if query_pos is not None:
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(280)forward()
-> if value is None:
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(280)forward()
-> if value is None:
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(280)forward()
-> if value is None:
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(280)forward()
-> if value is None:
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/modules/decoder.py(280)forward()
-> if value is None:
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(249)forward()
-> active_track_instances = self._select_active_tracks(data)
(Pdb) 244  	
245  	        return active_track_instances
246  	
247  	    def forward(self, data) -> Instances:
248  	        import pdb; pdb.set_trace()
249  ->	        active_track_instances = self._select_active_tracks(data)
250  	        active_track_instances = self._update_track_embedding(
251  	            active_track_instances)
252  	        init_track_instances: Instances = data["init_track_instances"]
253  	        merged_track_instances = Instances.cat(
254  	            [init_track_instances, active_track_instances])
(Pdb) --Call--
> /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(229)_select_active_tracks()
-> def _select_active_tracks(self, data: dict) -> Instances:
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(230)_select_active_tracks()
-> track_instances: Instances = data["track_instances"]
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(231)_select_active_tracks()
-> if self.training:
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(232)_select_active_tracks()
-> active_idxes = (track_instances.obj_idxes >=
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(233)_select_active_tracks()
-> 0) & (track_instances.iou > 0.5)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(232)_select_active_tracks()
-> active_idxes = (track_instances.obj_idxes >=
(Pdb) 227  	        return active_track_instances
228  	
229  	    def _select_active_tracks(self, data: dict) -> Instances:
230  	        track_instances: Instances = data["track_instances"]
231  	        if self.training:
232  ->	            active_idxes = (track_instances.obj_idxes >=
233  	                            0) & (track_instances.iou > 0.5)
234  	            active_track_instances = track_instances[active_idxes]
235  	            # set -2 instead of -1 to ensure that these tracks will not be selected in matching.
236  	            active_track_instances = self._random_drop_tracks(
237  	                active_track_instances)
(Pdb) True
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(249)forward()
-> active_track_instances = self._select_active_tracks(data)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/nn/modules/module.py(1051)_call_impl()
-> return forward_call(*input, **kwargs)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/detectors/uniad_track.py(706)_forward_single_frame_inference()
-> out_track_instances = self.query_interact(tmp)
(Pdb) *** AttributeError: 'UniAD' object has no attribute 'args'
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/nn/modules/module.py(1051)_call_impl()
-> return forward_call(*input, **kwargs)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(249)forward()
-> active_track_instances = self._select_active_tracks(data)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(232)_select_active_tracks()
-> active_idxes = (track_instances.obj_idxes >=
(Pdb) *** Newest frame
(Pdb) {'qim_type': 'QIMBase', 'merger_dropout': 0, 'update_query_pos': True, 'fp_ratio': 0.3, 'random_drop': 0.1}
(Pdb) True
(Pdb) True
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(249)forward()
-> active_track_instances = self._select_active_tracks(data)
(Pdb) *** AttributeError: 'dict' object has no attribute 'shape'
(Pdb) dict_keys(['init_track_instances', 'track_instances'])
(Pdb) True
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/nn/modules/module.py(1051)_call_impl()
-> return forward_call(*input, **kwargs)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/detectors/uniad_track.py(706)_forward_single_frame_inference()
-> out_track_instances = self.query_interact(tmp)
(Pdb) > /opt/homebrew/anaconda3/envs/uniad/lib/python3.8/site-packages/torch/nn/modules/module.py(1051)_call_impl()
-> return forward_call(*input, **kwargs)
(Pdb) > /Users/liangming.xu/code/UniAD/projects/mmdet3d_plugin/uniad/dense_heads/track_head_plugin/modules.py(249)forward()
-> active_track_instances = self._select_active_tracks(data)
(Pdb) *** AttributeError: 'QueryInteractionModule' object has no attribute '__fields__'
(Pdb) ['T_destination', '__annotations__', '__call__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattr__', '__getattribute__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__setstate__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', '_add_fp_tracks', '_apply', '_backward_hooks', '_buffers', '_build_layers', '_call_impl', '_forward_hooks', '_forward_pre_hooks', '_get_backward_hooks', '_get_name', '_is_full_backward_hook', '_load_from_state_dict', '_load_state_dict_pre_hooks', '_maybe_warn_non_full_backward_hook', '_modules', '_named_members', '_non_persistent_buffers_set', '_parameters', '_random_drop_tracks', '_register_load_state_dict_pre_hook', '_register_state_dict_hook', '_replicate_for_data_parallel', '_reset_parameters', '_save_to_state_dict', '_select_active_tracks', '_slow_forward', '_state_dict_hooks', '_update_track_embedding', '_version', 'activation', 'add_module', 'apply', 'args', 'bfloat16', 'buffers', 'children', 'cpu', 'cuda', 'double', 'dropout', 'dropout1', 'dropout2', 'dropout_feat1', 'dropout_feat2', 'dropout_pos1', 'dropout_pos2', 'dump_patches', 'eval', 'extra_repr', 'float', 'forward', 'fp_ratio', 'get_buffer', 'get_parameter', 'get_submodule', 'half', 'linear1', 'linear2', 'linear_feat1', 'linear_feat2', 'linear_pos1', 'linear_pos2', 'load_state_dict', 'modules', 'named_buffers', 'named_children', 'named_modules', 'named_parameters', 'norm1', 'norm2', 'norm_feat', 'norm_pos', 'parameters', 'random_drop', 'register_backward_hook', 'register_buffer', 'register_forward_hook', 'register_forward_pre_hook', 'register_full_backward_hook', 'register_parameter', 'requires_grad_', 'self_attn', 'share_memory', 'state_dict', 'to', 'to_empty', 'train', 'training', 'type', 'update_query_pos', 'xpu', 'zero_grad']
(Pdb) <bound method Module.train of QueryInteractionModule(
  (self_attn): MultiheadAttention(
    (out_proj): NonDynamicallyQuantizableLinear(in_features=256, out_features=256, bias=True)
  )
  (linear1): Linear(in_features=256, out_features=256, bias=True)
  (dropout): Dropout(p=0, inplace=False)
  (linear2): Linear(in_features=256, out_features=256, bias=True)
  (linear_pos1): Linear(in_features=256, out_features=256, bias=True)
  (linear_pos2): Linear(in_features=256, out_features=256, bias=True)
  (dropout_pos1): Dropout(p=0, inplace=False)
  (dropout_pos2): Dropout(p=0, inplace=False)
  (norm_pos): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
  (linear_feat1): Linear(in_features=256, out_features=256, bias=True)
  (linear_feat2): Linear(in_features=256, out_features=256, bias=True)
  (dropout_feat1): Dropout(p=0, inplace=False)
  (dropout_feat2): Dropout(p=0, inplace=False)
  (norm_feat): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
  (norm1): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
  (norm2): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
  (dropout1): Dropout(p=0, inplace=False)
  (dropout2): Dropout(p=0, inplace=False)
)>
(Pdb) 